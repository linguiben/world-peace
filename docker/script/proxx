#!/usr/bin/env bash
# ====== åŸºæœ¬é…ç½®ï¼ˆä¿®æ”¹è¿™é‡Œï¼‰ ======
cd "$(dirname "$0")"
. .env
# æœ¬åœ° SOCKS ç«¯å£
LOCAL_PORT=1080

# æ˜¯å¦è‡ªåŠ¨è®¾ç½® Mac ç³»ç»Ÿä»£ç†ï¼ˆtrue/falseï¼‰
ENABLE_SYSTEM_PROXY=true

# Wi-Fi åç§°ï¼ˆMac ä¸€èˆ¬æ˜¯ Wi-Fiï¼Œå¦‚æ˜¯ Ethernet è¯·æ”¹ï¼‰
NETWORK_SERVICE="Wi-Fi"

# alias proxy-on="~/scripts/ecs-proxy.sh on"
# alias proxy-off="~/scripts/ecs-proxy.sh off"
# alias proxy-status="~/scripts/ecs-proxy.sh status"
# alias proxy-restart="~/scripts/ecs-proxy.sh restart"

# ssh -D 1080 sg.joveso.com
# [root@iZt4n3oaftioxvvbmvy9v7Z ~]# # proxy openned

# export ALL_PROXY=socks5://127.0.0.1:1080
# export ALL_PROXY=socks5h://127.0.0.1:1080 # support DNS 
# export HTTP_PROXY=http://127.0.0.1:1080
# export HTTPS_PROXY=https://127.0.0.1:1080
# echo "å½“å‰å‡ºå£IP: $(curl -s --max-time 1 ifconfig.me)"
# curl https://ifconfig.me #45.77.249.90
# curl -v --socks5-hostname 127.0.0.1:1080 https://api.openai.com

# ==================================

PID_FILE="/tmp/ecs_socks_proxy.pid"

status_proxy() {
    if lsof -i TCP:${LOCAL_PORT} >/dev/null 2>&1; then
        echo "ğŸŸ¢ ä»£ç†æ­£åœ¨è¿è¡Œ (127.0.0.1:${LOCAL_PORT})"
        echo "å½“å‰å‡ºå£IP: $(curl -s --max-time 1 ifconfig.me)"
    else
        echo "ğŸ”´ ä»£ç†æœªè¿è¡Œ"
    fi
}

start_proxy() {
    if lsof -i TCP:${LOCAL_PORT} >/dev/null 2>&1; then
        echo "âš ï¸  ç«¯å£ ${LOCAL_PORT} å·²è¢«å ç”¨ï¼Œå¯èƒ½ä»£ç†å·²åœ¨è¿è¡Œ"
        return
    fi

    echo "ğŸš€ å¯åŠ¨ SSH SOCKS ä»£ç†..."

    ssh -D ${LOCAL_PORT} \
        -C -N \
        -p ${SSH_PORT} \
        -o ServerAliveInterval=60 \
        -o ServerAliveCountMax=3 \
        ${ECS_USER}@${ECS_HOST} &

    SSH_PID=$!
    echo $SSH_PID > "${PID_FILE}"

    sleep 1

    if ps -p $SSH_PID > /dev/null; then
        echo "âœ… ä»£ç†å·²å¯åŠ¨ (PID: $SSH_PID)"
    else
        echo "âŒ ä»£ç†å¯åŠ¨å¤±è´¥"
        return
    fi

    if [ "$ENABLE_SYSTEM_PROXY" = true ]; then
        echo "ğŸ”§ è®¾ç½®ç³»ç»Ÿ SOCKS ä»£ç†..."
        networksetup -setsocksfirewallproxy "${NETWORK_SERVICE}" 127.0.0.1 ${LOCAL_PORT}
        networksetup -setsocksfirewallproxystate "${NETWORK_SERVICE}" on
        echo "âœ… ç³»ç»Ÿè®¾ç½®: ä½¿ç”¨ä»£ç†"
        status_proxy
    fi
}

stop_proxy() {
    if [ -f "${PID_FILE}" ]; then
        PID=$(cat "${PID_FILE}")
        if ps -p $PID > /dev/null 2>&1; then
            kill $PID
            echo "ğŸ›‘ å·²åœæ­¢ä»£ç† (PID: $PID)"
        fi
        rm -f "${PID_FILE}"
    else
        pkill -f "ssh -D ${LOCAL_PORT}"
        echo "ğŸ›‘ å·²å°è¯•å…³é—­æ‰€æœ‰ SOCKS ä»£ç†è¿›ç¨‹"
    fi

    if [ "$ENABLE_SYSTEM_PROXY" = true ]; then
        echo "ğŸ”§ å…³é—­ç³»ç»Ÿ SOCKS ä»£ç†..."
        networksetup -setsocksfirewallproxystate "${NETWORK_SERVICE}" off
        echo "âœ… ç³»ç»Ÿè®¾ç½®: å·²å–æ¶ˆ"
    fi
}

case "$1" in
    on)
        start_proxy
        ;;
    off)
        stop_proxy
        ;;
    status)
        status_proxy
        ;;
    restart)
        stop_proxy
        sleep 1
        start_proxy
        ;;
    *)
        echo "Usage: $0 {on|off|status|restart}"
        ;;
esac