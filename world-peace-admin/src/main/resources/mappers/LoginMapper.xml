<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jupiter.admin.mapper.LoginMapper">

    <select id="findByUsername" parameterType="String" resultType="com.jupiter.admin.entity.WpUser">
        SELECT id, username, password, created_at, last_login_at, login_count
        FROM wp_user
        WHERE username = #{username}
        LIMIT 1
    </select>

    <select id="checkUser" resultType="com.jupiter.admin.entity.WpUser">
        SELECT id, username, password, created_at, last_login_at, login_count
        FROM wp_user
        WHERE username = #{username} AND password = #{password}
        LIMIT 1
    </select>

    <update id="updateLoginInfo" parameterType="Long">
        UPDATE wp_user
        SET last_login_at = NOW(),
            login_count = COALESCE(login_count, 0) + 1
        WHERE id = #{id}
    </update>

    <select id="getTotalLoginCount" resultType="Long">
        SELECT COALESCE(SUM(login_count), 0) FROM wp_user
    </select>

    <update id="incrementVisitorCount">
        INSERT INTO wp_visitor_stats (id, visit_count, last_visit)
        VALUES (1, 1, NOW())
        ON CONFLICT (id) DO UPDATE SET
            visit_count = wp_visitor_stats.visit_count + 1,
            last_visit = NOW()
    </update>

    <select id="getVisitorCount" resultType="Long">
        SELECT COALESCE(visit_count, 0) FROM wp_visitor_stats WHERE id = 1
    </select>

    <insert id="insertVisitLog">
        INSERT INTO wp_visit_log (ip, path, method, user_agent, browser, referer, accept_language, created_at)
        VALUES (#{ip}, #{path}, #{method}, #{userAgent}, #{browser}, #{referer}, #{acceptLanguage}, NOW())
    </insert>

    <insert id="insertUser">
        INSERT INTO wp_user (username, password, created_at, login_count)
        VALUES (#{username}, #{password}, NOW(), 0)
    </insert>

    <select id="existsByUsername" parameterType="String" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM wp_user WHERE username = #{username})
    </select>

</mapper>
