<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JupiterSo - Portal</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/common.css" />
</head>
<body th:data-logged-in="${loggedIn}">

    <nav class="navbar">
        <div class="logo">JupiterSo</div>
        <div class="auth-controls">
            <div class="navbar-stats">
                <span class="badge">Visitors: <span th:text="${visitorCount}">0</span></span>
                <span class="badge">Logins: <span th:text="${loginCount}">0</span></span>
            </div>
            
            <div th:if="${loggedIn}" class="user-info" style="font-size: 0.9rem; color: var(--text);">
                <span>Welcome, <strong th:text="${currentUser.nickname != null && !#strings.isEmpty(currentUser.nickname) ? currentUser.nickname : currentUser.username}">User</strong></span>
                <a href="/logout" style="margin-left: 1rem; color: var(--text-muted); font-size: 0.85rem;">Logout</a>
            </div>
            
            <div th:unless="${loggedIn}">
                <button th:if="${loginAvailable}" onclick="openAuthModal()" class="btn-primary">Login</button>
                <button th:unless="${loginAvailable}" disabled style="opacity: 0.5; cursor: not-allowed; background: var(--text-muted); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px;">Unavailable</button>
            </div>
        </div>
    </nav>

    <header class="hero">
        <div class="container">
            <h2>Welcome to JupiterSo !</h2>
            <div class="quote-box">
                著名的JL说过，<strong>JupiterSo</strong> 是一个<strong>开源技术</strong>的<strong>宝地</strong>。
            </div>
        </div>
    </header>

    <main class="container">
        <div class="services-grid">
            <a href="/jupiter/websocket" target="_blank" class="service-card">
                <h3>Chat Room</h3>
                <p>进入聊天室</p>
            </a>
            
            <a href="http://www.jupiterSo.com/ruoyi/" target="_blank" class="service-card">
                <h3>Admin Panel</h3>
                <p>后台管理</p>
            </a>
            
            <a href="#" onclick="openCloudSpace(event)" class="service-card">
                <h3>免费云空间</h3>
                <p>Storage Service</p>
            </a>
            
            <a href="/shop" target="_blank" class="service-card">
                <h3>Shop</h3>
                <p>京西商城</p>
            </a>
            
            <a href="http://tx.jupiterSo.com:8989" class="service-card">
                <h3>Jenkins</h3>
                <p>CI/CD Platform</p>
            </a>
            
            <a href="/guestbook" class="service-card">
                <h3>留言板</h3>
                <p>写下你的建议与想法</p>
            </a>
            
             <a href="/pyda2" class="service-card">
                <h3>Python Quiz+</h3>
                <p>大数据分析刷题 (Enhanced)</p>
            </a>
            
            <a href="https://github.com/linguiben" target="_blank" class="service-card">
                <h3>GitHub</h3>
                <p>GitHub Repository</p>
            </a>
            
            <a href="https://gitee.com/linguiben" target="_blank" class="service-card">
                <h3>Gitee</h3>
                <p>Gitee Repository</p>
            </a>
        </div>
    </main>

    <section class="banner-section">
        <div class="container">
            <div class="banner-container">
                <img src="/images/banner.jpg" alt="Jupiter Island Panorama">
            </div>
            <div style="margin-top: 0rem;">
                <a href="http://www.jupiterisland.com" target="_blank" style="color: var(--primary); font-weight: 500; font-size: 0.9rem;">
                    友情链接: Jupiter岛 &rarr;
                </a>
            </div>
        </div>
    </section>

    <div class="footer" th:replace="bottom :: bottom"></div>

    <div id="authModal" class="modal-overlay">
        <div class="modal">
            <button class="close-modal" onclick="closeAuthModal()">&times;</button>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">Sign In</button>
                <button class="auth-tab" onclick="switchTab('register')">Sign Up</button>
            </div>
            
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" name="username" required placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" name="password" required placeholder="Enter your password">
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 0.5rem;">Sign In</button>
                <div id="loginError" class="form-error"></div>
            </form>
            
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="regUsername">Email</label>
                    <input type="email" id="regUsername" name="username" required placeholder="you@example.com" minlength="3" maxlength="50">
                </div>
                <div class="form-group">
                    <label for="regNickname">Nickname</label>
                    <input type="text" id="regNickname" name="nickname" required placeholder="Your nickname" minlength="2" maxlength="30">
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" name="password" required placeholder="Choose a password" minlength="6">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Confirm Password</label>
                    <input type="password" id="regConfirmPassword" name="confirmPassword" required placeholder="Confirm your password">
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 0.5rem;">Sign Up</button>
                <div id="registerError" class="form-error"></div>
                <div id="registerSuccess" class="form-success"></div>
            </form>
        </div>
    </div>

    <div id="cloudLoginModal" class="modal-overlay">
        <div class="modal" style="max-width: 360px; text-align: center;">
            <button class="close-modal" onclick="closeCloudLoginModal()">&times;</button>
            <h3 style="margin-bottom: 0.5rem;">Please login</h3>
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.25rem;">Login required to access Free Cloud Space.</p>
            <button class="btn-primary" onclick="openAuthModal(); closeCloudLoginModal();">Login</button>
        </div>
    </div>

    <script>
        function openCloudSpace(e) {
            if (e) e.preventDefault();
            const loggedIn = document.body.getAttribute('data-logged-in') === 'true';
            if (!loggedIn) {
                openCloudLoginModal();
                return;
            }
            window.open('/test', '_blank');
        }

        function openCloudLoginModal() {
            document.getElementById('cloudLoginModal').classList.add('active');
        }

        function closeCloudLoginModal() {
            document.getElementById('cloudLoginModal').classList.remove('active');
        }

        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('loginUsername').focus();
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('registerSuccess').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = document.querySelectorAll('.auth-form');
            
            tabs.forEach(t => t.classList.remove('active'));
            forms.forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').classList.add('active');
                document.getElementById('loginUsername').focus();
            } else {
                tabs[1].classList.add('active');
                document.getElementById('registerForm').classList.add('active');
                document.getElementById('regUsername').focus();
            }
            
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
            document.getElementById('registerSuccess').style.display = 'none';
        }

        document.getElementById('authModal').addEventListener('click', function(e) {
            if (e.target === this) closeAuthModal();
        });
        document.getElementById('cloudLoginModal').addEventListener('click', function(e) {
            if (e.target === this) closeCloudLoginModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('authModal').classList.contains('active')) {
                closeAuthModal();
            }
            if (e.key === 'Escape' && document.getElementById('cloudLoginModal').classList.contains('active')) {
                closeCloudLoginModal();
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const errorDiv = document.getElementById('loginError');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.message || 'Login failed. Please check your credentials.';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Login error:', err);
                errorDiv.textContent = 'Connection error. Please try again later.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign In';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const errorDiv = document.getElementById('registerError');
            const successDiv = document.getElementById('registerSuccess');
            const submitBtn = form.querySelector('button[type="submit"]');
            
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const emailEl = document.getElementById('regUsername');
            const email = emailEl.value.trim();

            // Client-side: ensure email format
            if (!emailEl.checkValidity()) {
                errorDiv.textContent = '请输入合法的Email地址';
                errorDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.style.display = 'block';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Signing up...';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = data.message || 'Registration successful! Please sign in.';
                    successDiv.style.display = 'block';
                    form.reset();
                    setTimeout(() => switchTab('login'), 1500);
                } else {
                    errorDiv.textContent = data.message || 'Registration failed. Please try again.';
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                console.error('Register error:', err);
                errorDiv.textContent = 'Connection error. Please try again later.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Sign Up';
            }
        }
    </script>
</body>
</html>
